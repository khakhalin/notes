# Kubernetes

Parents: [[system_design]]
See also: [[docker]], [[flask]], [[microservice]]

#systems #tools


Kubertnetes is an open-source system (originally developed by Google) for coordinating [[docker]] containers on the cloud (something that is called **orchestration**). It operates **pods** that each contains several **containers**, that are placed together, within the same localhost. Pods can communicate with each other via pod IP. Kubernetes distributed containers across pods and also **nodes** (physical machines), allocates resources to them, automatically restart them if they fail, make sure that there's more than one instance of those containers that need to run in duplicate, and maintain load balancing across instances (see [[system_design]]).

# Preparing for deployment

.

# Deploying

.

# Monitoring and troubleshooting

First log in to [[aws]].

To see what pods are running: `kubectl get pods`. Also shows pod age, and the number of instances for each pod. Note that at least in some cases (ðŸ”¥ when?) kubernetes actually orchestrates the number of instances via a different mechanism, so it seems like all pods have only one instance, but actually they all look a bit like `meaningful_name-sd8fs-s8df8s0df98`, so some "generic name", followed by a hash-like autogenerated code that turns it into a "precise name". I'm not yet sure how it works exactly ðŸ”¥ , but it seems that some commands take a generic name, while some need a precise name (or maybe all names are "equipped" with a trailing wildcard at interpretation stage? ðŸ”¥ not sure)

To see logs (those produced by a logger): `kubectl logs specific_pod_name`, where the name can be taken from the pods list above. Note that the name in the pods list has a constant part (the beginning), and a unique part (the end) that is different for different instances, and changes when the pod restarts (?). For the log command you need the full version of the name (constant and variable), as you want to see logs of a particular instance of a pod. For some other commands below you only need the constant part, as you are scaling the number of pods, not a specific instance. (ðŸ”¥ not sure the terminology is correct here)

If the pod fails, you can try to summarize the reasons with `kubectl describe pods my_pod_name`

ssh into pod: `kubectl exec -it pod_name /bin/sh`

Restart pod: `kubectl delete pods pod_name_precise`. It deletes it indeed, but then kubernetes immediately restarts it. The name needs to be a precise one (?ðŸ”¥ ) as you're killing an instance.

Turn off a pod: `kubectl scale deploy pod_name_generic --replicas=0`. This is a cool not-quite-destructive operation, as the pod stil remains deployed, it just no longer has any running instances. Which means that doing `kubectl scale depoly pod_name --replicas=2` can bring instances back (2 instances in this case). Scaling down from 2 to 1 or vice versa may also be helpful sometimes (during troubleshooting, de-[[gridlock]]ing etc.). Note also that keys can go in any order (useful when manually rescaling several pods at once). ðŸ”¥ _is there an even more automated command for scaling down all pods, or all pods by one, or something like that?_

# Refs

https://www.oreilly.com/library/view/kubernetes-cookbook-2nd/9781788837606/c71faba3-73be-48db-89b9-7754625e98eb.xhtml